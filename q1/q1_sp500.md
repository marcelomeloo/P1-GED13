# Prova 1 de GED13
## ***Questão 1***
### Inicialização

```r
  library(tidyverse)
  library(ggplot2)
  library(quantmod) # Para usar o "getSymbols"
  library(data.table) # Para usar o "shift"
  library(ggpubr) # Para usar o "ggarrange" e "annotate_figure"
  library(cowplot) # Para fazer "qqplot" junto com histograma
  library(gridExtra) # Para inserir tabela no "qqplot"
  start <- as.Date("2022-01-01")
  end <- as.Date("2022-09-01")
```
### Dados do SP 500

```r
  dados.sp500 <- quantmod::getSymbols("^GSPC", src = "yahoo", from = start, to = end, auto.assign = FALSE)
  # head(dados.sp500)
  nasdaq <- na.omit(dados.sp500)
```

#### Cria o vetor de preco de fechamento

```r
  preco_fechamento <- dados.sp500$"GSPC.Close"
```

#### 1. Media do Preco de Fechamento

```r
  media_pf <- mean(preco_fechamento)
  media_pf
```

```
## [1] 4222.706
```

#### 2. Moda do Preco de Fechamento 

```r
  tab_preco_fechamento <- table(preco_fechamento)
  moda_pf <- names(tab_preco_fechamento)[which(tab_preco_fechamento==max(tab_preco_fechamento))]
  moda_pf
```

```
##   [1] "3666.77002"  "3674.840088" "3735.47998"  "3749.629883" "3759.889893" "3764.790039"
##   [7] "3785.379883" "3789.98999"  "3790.379883" "3795.72998"  "3801.780029" "3818.800049"
##  [13] "3818.830078" "3821.550049" "3825.330078" "3830.850098" "3831.389893" "3845.080078"
##  [19] "3854.429932" "3863.159912" "3899.379883" "3900.110107" "3900.790039" "3900.860107"
##  [25] "3901.360107" "3902.620117" "3911.73999"  "3921.050049" "3923.679932" "3930.080078"
##  [31] "3935.179932" "3936.689941" "3941.47998"  "3955"        "3959.899902" "3961.629883"
##  [37] "3966.840088" "3973.75"     "3978.72998"  "3986.159912" "3991.23999"  "3998.949951"
##  [43] "4001.050049" "4008.01001"  "4017.820068" "4023.610107" "4023.889893" "4030.610107"
##  [49] "4057.659912" "4057.840088" "4072.429932" "4088.850098" "4091.189941" "4101.22998" 
##  [55] "4108.540039" "4115.77002"  "4118.629883" "4121.430176" "4122.470215" "4123.339844"
##  [61] "4128.72998"  "4130.290039" "4131.930176" "4132.149902" "4137.990234" "4140.060059"
##  [67] "4140.77002"  "4145.189941" "4146.870117" "4151.939941" "4155.169922" "4155.379883"
##  [73] "4158.240234" "4160.680176" "4170.700195" "4173.109863" "4175.200195" "4175.47998" 
##  [79] "4176.819824" "4183.959961" "4199.120117" "4201.089844" "4204.310059" "4207.27002" 
##  [85] "4210.240234" "4225.5"      "4228.47998"  "4259.52002"  "4262.450195" "4271.779785"
##  [91] "4274.040039" "4277.879883" "4280.149902" "4283.740234" "4287.5"      "4288.700195"
##  [97] "4296.120117" "4297.140137" "4300.169922" "4304.759766" "4305.200195" "4306.259766"
## [103] "4326.509766" "4328.870117" "4348.870117" "4349.930176" "4356.450195" "4357.859863"
## [109] "4363.490234" "4373.939941" "4380.259766" "4384.649902" "4386.540039" "4391.689941"
## [115] "4392.589844" "4393.660156" "4397.450195" "4397.939941" "4401.669922" "4410.129883"
## [121] "4411.669922" "4412.529785" "4418.640137" "4431.850098" "4446.589844" "4456.240234"
## [127] "4459.450195" "4461.180176" "4462.209961" "4463.120117" "4471.069824" "4475.009766"
## [133] "4477.439941" "4481.149902" "4482.72998"  "4483.870117" "4488.279785" "4500.209961"
## [139] "4500.529785" "4504.080078" "4511.609863" "4515.549805" "4520.160156" "4521.540039"
## [145] "4525.120117" "4530.410156" "4532.759766" "4543.060059" "4545.859863" "4546.540039"
## [151] "4575.52002"  "4577.109863" "4582.640137" "4587.180176" "4589.379883" "4602.450195"
## [157] "4631.600098" "4659.029785" "4662.850098" "4670.290039" "4677.029785" "4696.049805"
## [163] "4700.580078" "4713.069824" "4726.350098" "4793.540039" "4796.560059"
```

#### 3. Mediana do Preco de Fechamento 

```r
  mediana_pf <- median(preco_fechamento)
  mediana_pf
```

```
## [1] 4207.27
```

#### 4. Variancia Nao Viesada 

```r
  variancia_pf <- var(preco_fechamento)
  variancia_pf
```

```
##            GSPC.Close
## GSPC.Close   72749.01
```

#### 5. Desvio-padrao 

```r
  desv_pad_pf <- sd(preco_fechamento)
  desv_pad_pf
```

```
## [1] 269.7202
```

#### 6. Grafico de linha do Preco de Fechamento 

```r
  ggplot(dados.sp500, aes(x = index(dados.sp500), y = preco_fechamento)) + geom_line() +
        labs(title="Grafico do SP 500", subtitle="Preco de Fechamento", caption="Fonte: https://finance.yahoo.com/", x = "Data ", y="Preco (R$)") +
        theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
        scale_x_date(date_labels = "%b %y", date_breaks = "1 month")
```

```
## Don't know how to automatically pick scale for object of type xts/zoo. Defaulting to continuous.
```

![plot of chunk unnamed-chunk-9](figure/unnamed-chunk-9-1.png)

#### 7. Retorno, com base no Preco de Fechamento 

```r
  retorno_pf <- (preco_fechamento - shift(preco_fechamento, 1L, type="lag"))/shift(preco_fechamento, 1L, type="lag")
  retorno_pf <- na.omit(retorno_pf)
  tabela_preco_retorno <- cbind(preco_fechamento, retorno_pf)
  head(tabela_preco_retorno)
```

```
##            GSPC.Close  GSPC.Close.1
## 2022-01-03    4796.56            NA
## 2022-01-04    4793.54 -0.0006296221
## 2022-01-05    4700.58 -0.0193927578
## 2022-01-06    4696.05 -0.0009637689
## 2022-01-07    4677.03 -0.0040502168
## 2022-01-10    4670.29 -0.0014410312
```

#### 8. Grafico de linha do Retorno 

```r
  ggplot(retorno_pf, aes(x = index(retorno_pf), y = 100*retorno_pf)) + geom_line() +
        labs(title="Grafico do SP 500", subtitle="Retorno", caption="Fonte: https://finance.yahoo.com/", x = "Data ", y="Retorno (%)") +
        theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
        scale_x_date(date_labels = "%b %y", date_breaks = "1 month")
```

```
## Don't know how to automatically pick scale for object of type xts/zoo. Defaulting to continuous.
```

![plot of chunk unnamed-chunk-11](figure/unnamed-chunk-11-1.png)

#### 9. Box plot para dados originais (Preco de Fechamento e Retorno) e padronizados 

```r
  boxplot_pf <- ggplot(data = preco_fechamento, aes(x = "", y = preco_fechamento))+
                      geom_violin(trim = FALSE, color="blue") +
                      geom_boxplot(width=0.4, color="blue", alpha = 1, outlier.size = 1) +
                      labs(x = "Preco", y = "") +
                      scale_y_continuous(breaks = seq(16, 23, by = 1))

  z_preco_fechamento <- (preco_fechamento - mean(preco_fechamento)) / sd(preco_fechamento)

  boxplot_z_pf <- ggplot(data = z_preco_fechamento, aes(x = "", y = z_preco_fechamento)) +
                        geom_violin(trim = FALSE, color="goldenrod3") +
                        geom_boxplot(width=0.4, color="red", alpha = 1, outlier.size = 1)+
                        labs(x = "Preco Padronizado", y = "") +
                        scale_y_continuous(breaks = seq(-5, 23, by = 1))

  boxplots_pf <- ggarrange(boxplot_pf, boxplot_z_pf,ncol = 2, nrow = 1)
  annotate_figure(boxplots_pf, top = text_grob("Boxplot/Vioplot do Preco de Fechamento\ne Preco de Fechamento Padronizado", color = "Black", face = "bold", size = 14),
                  bottom = text_grob("Fonte: https://finance.yahoo.com/", color = "black", hjust = 1.02, x = 1,size = 10))
```

![plot of chunk unnamed-chunk-12](figure/unnamed-chunk-12-1.png)

```r
  boxplot_retorno <- ggplot(data = retorno_pf, aes(x = "", y = 100*retorno_pf)) +
                            geom_violin(trim = FALSE, color="blue") +
                            geom_boxplot(width=0.4, color="blue", alpha = 1, outlier.size = 1) +
                            labs(x = "Retorno (%)", y = "") +
                            scale_y_continuous(breaks = seq(-7, 6, by = 2))

  z_retorno_pf <- (retorno_pf - mean(retorno_pf))/(sd(retorno_pf))

  boxplot_z_retorno_pf <- ggplot(data = z_retorno_pf, aes(x = "", y = z_retorno_pf)) +
                            geom_violin(trim = FALSE, color="red") +
                            geom_boxplot(width=0.4, color="red", alpha = 1, outlier.size = 1) +
                            labs(x = "Retorno Padronizado", y = "") +
                            scale_y_continuous(breaks = seq(-3, 11, by = 2))

  boxplots_retorno <- ggarrange(boxplot_retorno, boxplot_z_retorno_pf,ncol = 2, nrow = 1)
  annotate_figure(boxplots_retorno, top = text_grob("Boxplot/Vioplot do Retorno\ne Retorno Padronizado",
                  color = "Black", face = "bold", size = 14),
                  bottom = text_grob("Fonte: https://finance.yahoo.com/",
                  color = "black", hjust = 1.02, x = 1, size = 10))
```

![plot of chunk unnamed-chunk-12](figure/unnamed-chunk-12-2.png)

#### 10. Histograma para dados originais (Preco de Fechamento e Retorno) e padronizados 

```r
  histograma_pf <- ggplot(data = preco_fechamento,aes(x = preco_fechamento)) +
                          geom_histogram(color="blue", fill = "white", bins = 30) +
                          labs(y = "Quantidade", x = "Preco") +
                          scale_x_continuous(breaks = seq(17, 22, by = 0.5)) +
                          scale_y_continuous(breaks = seq(0, 30, by = 5)) +
                          theme(plot.title = element_text(hjust = 0.5))

  histograma_z_pf <- ggplot(data = z_preco_fechamento,aes(x = z_preco_fechamento)) +
                            geom_histogram(color="red", fill = "white", bins = 30) +
                            labs(y = "Quantidade", x = "Preco Padronizado") +
                            scale_x_continuous(breaks = seq(-2, 3.5, by = 0.5)) +
                            scale_y_continuous(breaks = seq(0, 50, by = 5)) +
                            theme(plot.title = element_text(hjust = 0.5))

  histogramas_pf <- ggarrange(histograma_pf, histograma_z_pf,ncol = 1, nrow = 2)
  annotate_figure(histogramas_pf, top = text_grob("Histograma do Preco de Fechamento",
                  color = "Black", face = "bold", size = 14),
                  bottom = text_grob("Fonte: https://finance.yahoo.com/",
                  color = "black", hjust = 1.02, x = 1, size = 10))
```

![plot of chunk unnamed-chunk-13](figure/unnamed-chunk-13-1.png)

```r
  histograma_retorno <- ggplot(data = retorno_pf,aes(x = 100*retorno_pf)) + 
                                geom_histogram(color="blue", fill = "white", bins = 25) + 
                                labs(y = "Quantidade", x = "Retorno (%)") + 
                                scale_x_continuous(breaks = seq(-6, 6, by = 1)) + 
                                scale_y_continuous(breaks = seq(0, 40, by = 5)) + 
                                theme(plot.title = element_text(hjust = 0.5))

  histograma_z_retorno <- ggplot(data = z_retorno_pf ,aes(x = z_retorno_pf)) + 
                                geom_histogram(color="red", fill = "white", bins = 25) + 
                                labs(y = "Quantidade", x = "Retorno Padronizado") + 
                                scale_x_continuous(breaks = seq(-6, 6, by = 1)) + 
                                scale_y_continuous(breaks = seq(0, 35, by = 5)) + 
                                theme(plot.title = element_text(hjust = 0.5))

  histogramas_retorno <- ggarrange(histograma_retorno, histograma_z_retorno,ncol = 1, nrow = 2)
  annotate_figure(histogramas_retorno, top = text_grob("Histograma do Retorno",
                  color = "Black", face = "bold", size = 14),
                  bottom = text_grob("Fonte: https://finance.yahoo.com/",
                  color = "black", hjust = 1.02, x = 1, size = 10))
```

![plot of chunk unnamed-chunk-13](figure/unnamed-chunk-13-2.png)

#### 11. QQPlot do retorno.  

```r
  qqplot_retorno <- ggplot(data = retorno_pf, aes(sample = 100*as.vector(retorno_pf))) +
                          stat_qq(size = 0.6) +labs(x = "Quantis Teoricos", y = "Quantis Amostrais",
                          title = "QQPlot do Retorno (%)") + theme(plot.title = element_text(hjust = 0.5)) +
                          scale_y_continuous(breaks = seq(-6, 4.5, by = 1.5))
```

#### 12. QQLine do retorno (fazer junto com o QQPlot).  

```r
  histograma_retorno_qqplot <- ggplot(data = retorno_pf,aes(x = 100*retorno_pf)) +
                                      geom_histogram(aes(y=..density..),color="blue", fill = "white", bins = 25) +
                                      stat_function(fun = dnorm, args = list(mean = mean(100*retorno_pf), sd = sd(100*retorno_pf)),
                                      col="red",lwd=1)+ theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
                                      labs(y = "", x = "") 

  qqplot_linha_retorno <- ggplot(data = retorno_pf, aes(sample = 100*as.vector(retorno_pf))) +
                                stat_qq(size = 0.6) + labs(x = "Quantis Teoricos", y = "Quantis Amostrais", title = "QQPlot do Retorno (%)") +
                                theme(plot.title = element_text(hjust = 0.5)) +scale_y_continuous(breaks = seq(-6, 4.5, by = 1.5)) +
                                stat_qq_line(col = 2,lwd=1,lty=1) 

  plot_principal <- qqplot_linha_retorno

  plot_para_inserir <- histograma_retorno_qqplot

  plot.com.insercao <- ggdraw() + draw_plot(plot_principal) + draw_plot(plot_para_inserir, x = 0.07, y = 0.6, width = .3, height = .3)
```

```
## Don't know how to automatically pick scale for object of type xts/zoo. Defaulting to continuous.
```

```r
  plot.com.insercao
```

![plot of chunk unnamed-chunk-15](figure/unnamed-chunk-15-1.png)

#### 13. Assimetria amostral nao viesada do retorno.   

```r
  n <- length(retorno_pf)
  somatorio <- c()
  for(i in 1:n){
    somatorio[i] <- ((retorno_pf[i] - mean(retorno_pf))/ sd(retorno_pf))^3
  }
  p1_s3 <- n/((n -1)*(n-2))
  p2_s3 <- sum(somatorio)
  s3 <- p1_s3*p2_s3
  s3
```

```
## [1] -0.212796
```

#### 14. Curtose amostral nao viesada do retorno.   

```r
  n <- length(retorno_pf)
  somatorio <- c()
  for(i in 1:n){
    somatorio[i] <- ((retorno_pf[i] - mean(retorno_pf))/ sd(retorno_pf))^4
  }
  p1_s4 <- (n*(n +1))/((n -1)*(n-2)*(n-3))
  p2_s4 <- (sum(somatorio))
  p3_s4 <- (3*((n-1)^2))/((n-2)*(n-3))
  s4 <- p1_s4 * p2_s4 - p3_s4
  s4
```

```
## [1] -0.1196638
```



```r
  library("knitr")
  knit("./q1/q1_sp500.rmd", output = "./q1/q1_sp500.md")
```

```
## Warning in file(con, "r"): cannot open file './q1/q1_sp500.rmd': No such file or directory
```

```
## Error in file(con, "r"): cannot open the connection
```
